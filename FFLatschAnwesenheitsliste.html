<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feuerwehr â€“ Anwesenheitsliste</title>

  <style>
    :root{
      --bg:#0b1220;
      --text:#e8eefc;
      --muted:#a9b6d6;
      --good:#34d399;
      --warn:#fbbf24;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--font);
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(94,234,212,.10), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(99,102,241,.12), transparent 60%),
        var(--bg);
      color: var(--text);
    }
    header{
      padding: 20px 18px 10px;
      max-width: 1280px;
      margin: 0 auto;
    }
    h1{ margin:0 0 6px; font-size: 22px; letter-spacing:.2px; }
    .sub{ color: var(--muted); font-size: 13px; line-height:1.35; }

    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 12px 18px 40px;
      display: grid;
      grid-template-columns: 560px 1fr;
      gap: 16px;
    }
    @media (max-width: 1080px){ .wrap{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .hd{
      padding: 12px 14px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .card .hd b{ font-size: 14px; }
    .card .bd{ padding: 14px; }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input, select, textarea{
      width:100%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
    }
    textarea{ min-height: 68px; resize: vertical; }



/* Dark dropdown (BrowserabhÃ¤ngig, hilft in vielen FÃ¤llen) */
select{
  color-scheme: dark;               /* sagt dem Browser: bitte dark UI */
}

/* Dropdown-Liste */
select option{
  background: #0b1220;              /* dunkel */
  color: #e8eefc;                   /* hell */
}

/* markierte/aktive Option */
select option:checked{
  background: rgba(94,234,212,.22); /* leichtes Highlight */
  color: #e8eefc;
}

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 560px){ .row{ grid-template-columns: 1fr; } }

    .btns{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    button{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 11px;
      border-radius: 14px;
      cursor:pointer;
      transition: .15s transform;
    }
    button:hover{ transform: translateY(-1px); }
    .primary{
      border-color: rgba(94,234,212,.35);
      background: rgba(94,234,212,.12);
    }
    .danger{
      border-color: rgba(251,113,133,.35);
      background: rgba(251,113,133,.10);
    }
    .ghost{ background: transparent; }
    .small{ padding: 7px 9px; border-radius: 12px; font-size: 12px; }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
      background: rgba(0,0,0,.14);
      white-space: nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; display:inline-block; }
    .dot.good{ background: var(--good); }
    .dot.warn{ background: var(--warn); }
    .muted{ color: var(--muted); }

    /* ===== Mitgliederliste: ZEILEN SCHMÃ„LER ===== */
    .members{
      margin-top: 10px;
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      overflow:hidden;
    }
    .mem-row{
      display:grid;
      /* âœ… NUR 2 SPALTEN (kein LÃ¶schen direkt in der Liste) */
      grid-template-columns: minmax(210px, 1fr) minmax(260px, 1fr);
      gap: 10px;
      padding: 6px 10px;
      border-top: 1px solid var(--line);
      align-items:center;
      background: rgba(255,255,255,.02);
    }
    .mem-row:first-child{ border-top:none; }
    .member-name{
      font-size: 13px;
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @media (max-width: 900px){
      .mem-row{ grid-template-columns: 1fr; }
    }

    /* ===== SEGMENTED: IMMER 3 FELDER SICHTBAR (FLEX, KEIN GRID) ===== */
    .seg{
      display:flex;
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: rgba(0,0,0,.12);
      height: 30px;
    }
    .seg input{
      position: absolute;
      left: -9999px;
      opacity: 0;
    }
    .seg label{
      flex: 1 1 33.333%;
      min-width: 0;
      margin:0;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-size: 11px;
      color: var(--muted);
      border-right: 1px solid var(--line);
      padding: 0 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .seg label:last-child{ border-right:none; }
    .seg label:hover{ background: rgba(255,255,255,.04); }

    .seg input:checked + label{
      color: var(--text);
      background: rgba(255,255,255,.06);
    }
    .seg input[value="Anwesend"]:checked + label{ background: rgba(52, 211, 153, .16); }
    .seg input[value="Entschuldigt"]:checked + label{ background: rgba(251, 191, 36, .16); }
    .seg input[value=""]:checked + label{ background: rgba(255,255,255,.03); color: var(--muted); }

    @media (max-width: 420px){
      .seg{ height: 28px; }
      .seg label{ font-size: 10px; padding: 0 4px; }
    }

    /* KPI / sections */
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 680px){ .grid2{ grid-template-columns: 1fr; } }
    .kpi{
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.02);
    }
    .kpi b{ font-size: 13px; display:block; margin-bottom: 6px; }
    .kpi .val{ font-size: 20px; }

    .section{
      margin-top: 14px;
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      overflow: hidden;
      background: rgba(255,255,255,.02);
    }
    .section summary{
      cursor:pointer;
      padding: 10px 12px;
      user-select:none;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      list-style: none;
    }
    .section summary::-webkit-details-marker{ display:none; }
    .section .content{ padding: 12px; border-top: 1px solid var(--line); }

    table{ width:100%; border-collapse: collapse; font-size: 13px; }
    th, td{ padding: 10px 10px; border-bottom: 1px solid var(--line); vertical-align: top; }
    th{
      text-align:left;
      color: var(--muted);
      font-weight: 600;
      background: rgba(255,255,255,.02);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .actions-cell{ white-space: nowrap; }

    .pill{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      margin-right: 6px;
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    details.inline{
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 8px 10px;
      background: rgba(0,0,0,.12);
    }
    details.inline > summary{
      cursor: pointer;
      color: var(--muted);
      user-select: none;
      list-style: none;
    }
    details.inline > summary::-webkit-details-marker{ display:none; }

    .footerbar{
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .file{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="file"]{ padding: 8px; }

    .hint{ margin-top: 10px; color: var(--muted); font-size: 12px; line-height: 1.35; }


/* ===================================================== */
/* KOMPAKT â€“ NUR: EintrÃ¤ge (kompakt, Details per Klick)   */
/* ===================================================== */

#entriesSection .content{ padding: 8px; } /* weniger Luft in der Section */

#entriesSection table{
  font-size: 12px;
}

#entriesSection th,
#entriesSection td{
  padding: 6px 8px;     /* schmalere Zeilen */
  vertical-align: top;
}

#entriesSection th{
  font-size: 11.5px;
  padding: 7px 8px;
}

/* Pills kompakter */
#entriesSection .pill{
  padding: 1px 6px;
  font-size: 11px;
  margin: 2px 4px 0 0;
}

/* Aktionen untereinander, kompakt */
#entriesSection .actions-cell{
  white-space: normal; /* wichtig: Buttons dÃ¼rfen umbrechen/stacken */
}

#entriesSection .entry-actions{
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: flex-start;
}

#entriesSection .entry-actions button{
  padding: 5px 7px;
  font-size: 11px;
  border-radius: 10px;
}

/* Details-Box innerhalb der Aktion kompakt */
#entriesSection .entry-details{
  margin-top: 6px;
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 6px 8px;
  background: rgba(0,0,0,.10);
}

#entriesSection .entry-details .pill{
  margin-top: 4px;
}

/* ===================================================== */
/* NOCH KOMPAKTER: Mitglieder-Anwesenheitszeilen         */
/* ===================================================== */

/* gesamte Zeile schmÃ¤ler */
.mem-row{
  padding: 4px 8px;      /* vorher 6px 10px */
  gap: 8px;
}

/* Name etwas kompakter */
.member-name{
  font-size: 12.5px;     /* vorher 13px */
  line-height: 1.1;
}

/* Segment-Buttons flacher */
.seg{
  height: 26px;          /* vorher 30px */
  border-radius: 12px;
}

/* Text in den Segmenten kleiner */
.seg label{
  font-size: 10.5px;     /* vorher 11px */
  padding: 0 4px;
}

/* Alarmstufe "aufgeklappt" als Liste */
select.alarm-open{
  height: auto;
  padding-top: 6px;
  padding-bottom: 6px;
}

  </style>
</head>

<body>
<header>
  <h1>Feuerwehr â€“ Anwesenheitsliste</h1>
  <div class="sub">
    Klickfelder je Mitglied: <b>Anwesend</b> / <b>Entschuldigt</b> / <b>â€“</b> (leer).<br/>
    Auswertung: Pro Mitglied nur <b>Anwesend</b> getrennt nach Ãœbung/Einsatz/Prozession/Bereitschaftsdienst/Veranstaltung/Sonstiges.
    EinsÃ¤tze zusÃ¤tzlich nach <b>Alarmstufe</b>. Immer nach <b>Jahr</b> filterbar.
  </div>
</header>

<div class="wrap">
  <!-- LEFT -->
  <section class="card" id="formCard">
    <div class="hd">
      <b id="formTitle">Neuen Eintrag anlegen</b>
      <span class="tag"><span class="dot good"></span>localStorage</span>
    </div>

    <div class="bd">
      <div class="row">
        <div>
          <label for="date">Datum</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label for="type">Art</label>
          <select id="type">
            <option>Ãœbung</option>
            <option>Einsatz</option>
            <option>Prozession</option>
            <option>Bereitschaftsdienst</option>
            <option>Veranstaltung</option>
            <option>Sonstiges</option>
          </select>
        </div>
      </div>

      <label for="alarm">Alarmstufe (nur relevant bei Einsatz)</label>
      <select id="alarm">
        <option value="">â€”</option>
        <option>A1</option><option>A2</option><option>A3</option><option>A4</option>
        <option>A5</option><option>A6</option><option>A7</option><option>A8</option>
      </select>

      <label for="title">Titel (optional)</label>
      <input id="title" type="text" placeholder="z.B. Atemschutzprobe, Branddienst, Dorffestâ€¦" />

      <label for="note">Notiz (optional)</label>
      <textarea id="note" placeholder="z.B. Treffpunkt, Startzeit, Besonderheitenâ€¦"></textarea>

      <label>Anwesenheit je Mitglied (kann leer bleiben)</label>
      <details class="inline">
        <summary>Mitglieder verwalten (Neuaufnahme / Austritt)</summary>
        <div style="margin-top:10px;display:grid;gap:10px;">
          <div class="row">
            <div>
              <label for="newMember" style="margin:0 0 6px;">Neues Mitglied</label>
              <input id="newMember" type="text" placeholder="Vorname Nachname" />
            </div>
            <div style="display:flex;gap:10px;align-items:flex-end;">
              <button class="small primary" id="addMemberBtn" type="button">HinzufÃ¼gen</button>
              <button class="small" id="refreshMembersBtn" type="button">Aktualisieren</button>
            </div>
          </div>
          <div class="muted" style="font-size:12px;line-height:1.35;">
            Hinweis: Mitglieder entfernen ist nur hier mÃ¶glich. Bereits gespeicherte EintrÃ¤ge bleiben unverÃ¤ndert (Historie bleibt erhalten).
          </div>
          <div id="memberAdminList" style="display:grid;gap:6px;"></div>
        </div>
      </details>

      <div class="members" id="membersBox"></div>

      <div class="btns">
        <button class="primary" id="saveBtn">Speichern</button>
        <button class="ghost" id="resetBtn">ZurÃ¼cksetzen</button>
        <button class="danger" id="deleteBtn" style="display:none;">Eintrag lÃ¶schen</button>
      </div>

      <div class="hint">Tipp: â€žâ€“â€œ bedeutet: nicht hinterlegt.</div>
    </div>

    <div class="footerbar">
      <div class="file">
        <button class="small" id="exportBtn">CSV Export</button>
        <label class="small" style="margin:0;">CSV Import</label>
        <input id="importFile" type="file" accept=".csv,text/csv" />
      </div>
      <button class="small danger" id="wipeBtn">Alles lÃ¶schen</button>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <div class="hd">
      <b>Ãœbersicht & Filter</b>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
        <span class="tag"><span class="dot good"></span>Anwesend</span>
        <span class="tag"><span class="dot warn"></span>Entschuldigt</span>
        <span class="tag"><span class="dot good" style="opacity:.5;"></span>â€“</span>
      </div>
    </div>

    <div class="bd">
      <label>Filter</label>
      <div class="row">
        <div>
          <label for="filterYear" style="margin-top:0;">Jahr</label>
          <select id="filterYear"></select>
        </div>
        <div>
          <label for="filterType" style="margin-top:0;">Art</label>
          <select id="filterType">
            <option value="ALLE">Alle Arten</option>
            <option value="Ãœbung">Ãœbung</option>
            <option value="Einsatz">Einsatz</option>
            <option value="Prozession">Prozession</option>
            <option value="Bereitschaftsdienst">Bereitschaftsdienst</option>
            <option value="Veranstaltung">Veranstaltung</option>
            <option value="Sonstiges">Sonstiges</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="filterMember" style="margin-top:10px;">Mitglied</label>
          <select id="filterMember">
            <option value="ALLE">Alle Mitglieder</option>
          </select>
        </div>
        <div>
          <label style="margin-top:10px;">Aktion</label>
          <div class="btns" style="margin-top:0;">
            <button class="small" id="applyFilterBtn">Filter anwenden</button>
            <button class="small ghost" id="clearFilterBtn">ZurÃ¼cksetzen</button>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="kpi">
          <b>EintrÃ¤ge im Jahr (ohne Mitgliedsfilter)</b>
          <div class="val" id="kpiTotal">0</div>
          <div class="muted" style="font-size:12px;margin-top:4px;">
            (Ãœbung + Einsatz + Prozession + Bereitschaftsdienst + Veranstaltung + Sonstiges)
          </div>
        </div>
        <div class="kpi">
          <b>MÃ¶gliche Teilnahmen (nach Art)</b>
          <div class="muted" id="kpiPossible" style="font-size:13px;line-height:1.5;"></div>
        </div>
      </div>

      <details class="section" open id="entriesSection">
        <summary>
          <span><b>Auswertung je Mitglied</b> (nur â€žAnwesendâ€œ)</span>
          <span class="tag"><span class="dot good"></span>Jahresfilter</span>
        </summary>
        <div class="content">
          <div id="statsBox"></div>
          <div class="hint">Es zÃ¤hlt nur â€žAnwesendâ€œ. â€žEntschuldigtâ€œ und â€žâ€“â€œ werden nicht gezÃ¤hlt.</div>
        </div>
      </details>

      <details class="section">
        <summary>
          <span><b>EinsÃ¤tze nach Alarmstufe</b> (Anzahl)</span>
          <span class="tag"><span class="dot warn"></span>Einsatz</span>
        </summary>
        <div class="content">
          <div id="alarmStatsBox"></div>
          <div class="hint">Hier wird nur gezÃ¤hlt, wie viele EinsÃ¤tze je Alarmstufe im Jahr erfasst wurden.</div>
        </div>
      </details>

      <details class="section" open>
        <summary>
          <span><b>EintrÃ¤ge</b> (kompakt, Details per Klick)</span>
          <span class="tag"><span class="dot good" style="opacity:.8;"></span>Liste</span>
        </summary>
        <div class="content">
          <div style="overflow:auto; border:1px solid var(--line); border-radius: var(--radius2);">
            <table>
              <thead>
                <tr>
                  <th style="min-width:120px;">Datum</th>
                  <th style="min-width:160px;">Art</th>
                  <th style="min-width:260px;">Titel/Notiz</th>
                  <th style="min-width:320px;">Auswertung (Anwesend / Hinterlegt)</th>
                  <th class="actions-cell" style="min-width:120px;">Aktion</th>
                </tr>
              </thead>
              <tbody id="entriesBody"></tbody>
            </table>
          </div>
        </div>
      </details>
    </div>
  </section>
</div>

<script>
  const MEMBERS_DEFAULT = [
    "Auer Manuel","Auer Marc","Bachmann Markus","Bagolin Claudio","DonÃ¡ Fabian","Egger Raffael","FischbÃ¶ck Franz",
    "Fischer Andreas","Fischer Philipp","Fleischmann Patrick","Forcher Simon","Fuchs Matthias","Gruber Jan","Gruber Reinhard",
    "Janser Thomas","Kaserer Herbert","Kaserer Paul","Kupperion Kathrin","Kupperion Nadine","Lamprecht Maximilian","Linser Fabian",
    "Linser Ulrich","Linser Werner","Mair Ulrich","Mantinger Alexander","Mantinger Simon","Mitterer Manuel","Nardelli Philipp",
    "Oberhofer Anna","Oberhofer Paula","Patscheider Stefan","Pauli Theodor","Paulmichl Heiko","Pedross Patrick","Pegger Bernhart",
    "Pegger Daniel","Pegger Martin","Pircher Manfred","Platzgummer Martin","PlÃ¶rer Tanja","PÃ¶hli Oliver","Pramstaller Werner",
    "Prantner Markus","Prantner Maximilian","Rinner Christoph","Rinner HansjÃ¶rg","Ritter Paul","Rizzi Lukas","Schweitzer Peter Paul",
    "Stecher Manfred","Tappeiner Johannes","Trafoier Norbert Franz","Tscholl Stefan","Weitgruber Andreas","Weitgruber Felix",
    "Wellenzohn Alex","Wielander Alexander"
  ];

  const LS_MEMBERS_KEY = "fw_members_v1";

  function normalizeMemberName(name){
    return String(name ?? "").trim().replace(/\s+/g, " ");
  }

  function loadMembers(){
    try{
      const raw = localStorage.getItem(LS_MEMBERS_KEY);
      if(raw){
        const arr = JSON.parse(raw);
        if(Array.isArray(arr) && arr.length){
          const cleaned = Array.from(new Set(arr.map(normalizeMemberName).filter(Boolean)))
            .sort((a,b)=> a.localeCompare(b, "de"));
          localStorage.setItem(LS_MEMBERS_KEY, JSON.stringify(cleaned));
          return cleaned;
        }
      }
    } catch {}

    // Seed with default list if nothing stored yet (sortiert)
    const seeded = [...MEMBERS_DEFAULT].sort((a,b)=> a.localeCompare(b, "de"));
    localStorage.setItem(LS_MEMBERS_KEY, JSON.stringify(seeded));
    return seeded;
  }

  function saveMembers(list){
    const cleaned = Array.from(new Set((list || []).map(normalizeMemberName).filter(Boolean)))
      .sort((a,b)=> a.localeCompare(b, "de"));
    localStorage.setItem(LS_MEMBERS_KEY, JSON.stringify(cleaned));
    return cleaned;
  }

  let MEMBERS = loadMembers();

  const LS_KEY = "fw_attendance_fixedseg_v3";
  let data = load();
  let editId = null;
  let activeFilter = { year: "", type: "ALLE", member: "ALLE" };

  const membersBox = document.getElementById("membersBox");
  const filterMember = document.getElementById("filterMember");
  const filterYear = document.getElementById("filterYear");

  // Build / rebuild members UI
  function buildMembersUI(){
    membersBox.innerHTML = "";
    filterMember.innerHTML = '<option value="ALLE">Alle Mitglieder</option>';

    MEMBERS.forEach(m => {
      const row = document.createElement("div");
      row.className = "mem-row";

      const hid = hashId(m);
      const group = `att_${hid}`;
      const idA = `${hid}_a`;
      const idE = `${hid}_e`;
      const id0 = `${hid}_0`;

      // âœ… Kein LÃ¶schen-Button in der Liste
      row.innerHTML = `
        <div class="member-name" title="${escapeHtml(m)}">${escapeHtml(m)}</div>
        <div class="seg" data-member="${escapeAttr(m)}">
          <input type="radio" id="${idA}" name="${group}" value="Anwesend">
          <label for="${idA}" title="Anwesend">Anwesend</label>

          <input type="radio" id="${idE}" name="${group}" value="Entschuldigt">
          <label for="${idE}" title="Entschuldigt">Entschuldigt</label>

          <input type="radio" id="${id0}" name="${group}" value="" checked>
          <label for="${id0}" title="Leer">â€“</label>
        </div>
      `;
      membersBox.appendChild(row);

      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      filterMember.appendChild(opt);
    });
  }

  function renderMemberAdminList(){
    const box = document.getElementById("memberAdminList");
    if(!box) return;
    box.innerHTML = "";
    if(!MEMBERS.length){
      box.innerHTML = '<div class="muted" style="font-size:12px;">Keine Mitglieder vorhanden.</div>';
      return;
    }

    MEMBERS.forEach(m=>{
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "10px";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.padding = "6px 8px";
      row.style.border = "1px solid var(--line)";
      row.style.borderRadius = "12px";
      row.style.background = "rgba(0,0,0,.10)";
      row.innerHTML = `
        <div style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(m)}</div>
        <button class="small danger" type="button" data-del-member-admin="${escapeAttr(m)}">Entfernen</button>
      `;
      box.appendChild(row);
    });

    // âœ… Entfernen NUR hier (Mitglieder verwalten)
    box.querySelectorAll('button[data-del-member-admin]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const name = btn.getAttribute("data-del-member-admin");
        if(!confirm(`Mitglied "${name}" wirklich entfernen?`)) return;

        MEMBERS = saveMembers(MEMBERS.filter(x => x !== name));

        if(activeFilter.member === name){
          activeFilter.member = "ALLE";
          document.getElementById("filterMember").value = "ALLE";
        }

        resetForm();
        buildMembersUI();
        renderMemberAdminList();
        renderAll();
      });
    });
  }

  buildMembersUI();
  renderMemberAdminList();

  document.getElementById("date").valueAsDate = new Date();

  document.getElementById("saveBtn").addEventListener("click", onSave);
  document.getElementById("resetBtn").addEventListener("click", resetForm);
  document.getElementById("deleteBtn").addEventListener("click", onDelete);

// ===== Alarmstufe nur bei Art "Einsatz" (mit Auto-Aufklappen) =====
const typeSelect = document.getElementById("type");
const alarmSelect = document.getElementById("alarm");

function closeAlarmList(){
  alarmSelect.size = 1;
  alarmSelect.classList.remove("alarm-open");
}

function openAlarmList(){
  // Optionen sichtbar machen (â€” + A1..A8)
  alarmSelect.size = alarmSelect.options.length;
  alarmSelect.classList.add("alarm-open");
  alarmSelect.focus();

  const onClose = () => {
    closeAlarmList();
    alarmSelect.removeEventListener("change", onClose);
    alarmSelect.removeEventListener("blur", onClose);
  };

  alarmSelect.addEventListener("change", onClose);
  alarmSelect.addEventListener("blur", onClose);
}

function updateAlarmAvailability(){
  if(typeSelect.value === "Einsatz"){
    const wasDisabled = alarmSelect.disabled;
    alarmSelect.disabled = false;

    // ðŸ‘‰ automatisch anzeigen beim Wechsel auf Einsatz
    if(wasDisabled){
      setTimeout(openAlarmList, 0);
    }
  } else {
    alarmSelect.value = "";
    alarmSelect.disabled = true;
    closeAlarmList();
  }
}

// Initial
updateAlarmAvailability();

// Reaktion auf Ã„nderung der Art
typeSelect.addEventListener("change", updateAlarmAvailability);


  document.getElementById("applyFilterBtn").addEventListener("click", () => {
    activeFilter.year = filterYear.value;
    activeFilter.type = document.getElementById("filterType").value;
    activeFilter.member = document.getElementById("filterMember").value;
    renderAll();
  });

  document.getElementById("clearFilterBtn").addEventListener("click", () => {
    const y = defaultYear();
    activeFilter = { year: y, type: "ALLE", member: "ALLE" };
    filterYear.value = y;
    document.getElementById("filterType").value = "ALLE";
    document.getElementById("filterMember").value = "ALLE";
    renderAll();
  });

  document.getElementById("exportBtn").addEventListener("click", exportCSV);
  document.getElementById("importFile").addEventListener("change", importCSV);
  document.getElementById("wipeBtn").addEventListener("click", wipeAll);

  // âœ… HinzufÃ¼gen: immer alphabetisch sortiert
  document.getElementById("addMemberBtn").addEventListener("click", () => {
    const inp = document.getElementById("newMember");
    const name = normalizeMemberName(inp.value);
    if(!name){ alert("Bitte Namen eingeben."); return; }
    if(MEMBERS.includes(name)){ alert("Mitglied existiert bereits."); return; }

    MEMBERS = saveMembers([...MEMBERS, name]); // saveMembers sortiert

    inp.value = "";
    resetForm();
    buildMembersUI();
    renderMemberAdminList();
    renderAll();
  });

  document.getElementById("refreshMembersBtn").addEventListener("click", () => {
    MEMBERS = loadMembers();
    resetForm();
    buildMembersUI();
    renderMemberAdminList();
    renderAll();
  });

  rebuildYearOptions();
  activeFilter.year = defaultYear();
  filterYear.value = activeFilter.year;

  renderAll();

  function onSave(){
    const date = document.getElementById("date").value;
    const type = document.getElementById("type").value;
    const alarm = document.getElementById("alarm").value || "";
    const title = document.getElementById("title").value.trim();
    const note = document.getElementById("note").value.trim();
    if(!date){ alert("Bitte Datum auswÃ¤hlen."); return; }

    const attendance = {};
    membersBox.querySelectorAll('.seg[data-member]').forEach(seg => {
      const m = seg.getAttribute("data-member");
      const checked = seg.querySelector('input[type="radio"]:checked');
      attendance[m] = checked ? checked.value : "";
    });

    const entry = { id: editId ?? cryptoId(), date, type, alarm, title, note, attendance };

    if(editId){
      const idx = data.entries.findIndex(e => e.id === editId);
      if(idx >= 0) data.entries[idx] = entry;
    } else data.entries.push(entry);

    data.entries.sort((a,b)=> b.date.localeCompare(a.date));
    save();
    rebuildYearOptions();
    resetForm();
    renderAll();
  }

  function startEdit(id){
    const e = data.entries.find(x => x.id === id);
    if(!e) return;

    editId = id;
    document.getElementById("formTitle").textContent = "Eintrag bearbeiten";
    document.getElementById("deleteBtn").style.display = "inline-block";

    document.getElementById("date").value = e.date;
    document.getElementById("type").value = e.type;
alarmSelect.value = e.alarm || "";
updateAlarmAvailability();
    document.getElementById("title").value = e.title || "";
    document.getElementById("note").value = e.note || "";

    membersBox.querySelectorAll('.seg[data-member]').forEach(seg => {
      const m = seg.getAttribute("data-member");
      const val = (e.attendance && (e.attendance[m] ?? "")) || "";
      const radio = seg.querySelector(`input[type="radio"][value="${cssEscape(val)}"]`);
      if(radio) radio.checked = true;
      else seg.querySelector('input[type="radio"][value=""]').checked = true;
    });

    document.getElementById("formCard").scrollIntoView({behavior:"smooth", block:"start"});
  }

  function onDelete(){
    if(!editId) return;
    if(!confirm("Eintrag wirklich lÃ¶schen?")) return;
    data.entries = data.entries.filter(e => e.id !== editId);
    save();
    rebuildYearOptions();
    resetForm();
    renderAll();
  }

  function resetForm(){
    editId = null;
    document.getElementById("formTitle").textContent = "Neuen Eintrag anlegen";
    document.getElementById("deleteBtn").style.display = "none";

    document.getElementById("date").valueAsDate = new Date();
    document.getElementById("type").value = "Ãœbung";
updateAlarmAvailability();
    document.getElementById("alarm").value = "";
    document.getElementById("title").value = "";
    document.getElementById("note").value = "";

    membersBox.querySelectorAll('.seg[data-member]').forEach(seg => {
      seg.querySelector('input[type="radio"][value=""]').checked = true;
    });
  }

  function wipeAll(){
    if(!confirm("Wirklich ALLE Daten lÃ¶schen?")) return;
    data = { entries: [] };
    save();
    rebuildYearOptions();
    resetForm();

    activeFilter.year = defaultYear();
    filterYear.value = activeFilter.year;
    document.getElementById("filterType").value = "ALLE";
    document.getElementById("filterMember").value = "ALLE";
    activeFilter.type = "ALLE";
    activeFilter.member = "ALLE";
    renderAll();
  }

  function renderAll(){
    const filtered = applyFilters(data.entries);
    renderKPIs();
    renderMemberStats();
    renderAlarmStats();
    renderEntries(filtered);
  }

  function renderKPIs(){
    const yearTypeOnly = data.entries.filter(e => {
      if(activeFilter.year && yearOf(e.date) !== activeFilter.year) return false;
      if(activeFilter.type !== "ALLE" && e.type !== activeFilter.type) return false;
      return true;
    });

    const totals = countByType(yearTypeOnly);
    document.getElementById("kpiTotal").textContent = String(yearTypeOnly.length);

    document.getElementById("kpiPossible").innerHTML = `
      <span class="pill">Ãœbung: ${totals["Ãœbung"]}</span>
      <span class="pill">Einsatz: ${totals["Einsatz"]}</span>
      <span class="pill">Prozession: ${totals["Prozession"]}</span>
      <span class="pill">Bereitschaft: ${totals["Bereitschaftsdienst"]}</span>
      <span class="pill">Veranstaltung: ${totals["Veranstaltung"]}</span>
      <span class="pill">Sonstiges: ${totals["Sonstiges"]}</span>
    `;
  }

  function renderMemberStats(){
    const box = document.getElementById("statsBox");
    box.innerHTML = "";

    const membersToShow = (activeFilter.member === "ALLE") ? MEMBERS : [activeFilter.member];

    const base = data.entries.filter(e => {
      if(activeFilter.year && yearOf(e.date) !== activeFilter.year) return false;
      if(activeFilter.type !== "ALLE" && e.type !== activeFilter.type) return false;
      if(activeFilter.member !== "ALLE"){
        const v = (e.attendance && (e.attendance[activeFilter.member] ?? "")) || "";
        if(v === "") return false;
      }
      return true;
    });

    const rows = membersToShow.map(m => {
      let u=0, ei=0, pr=0, bd=0, va=0, so=0;

      base.forEach(e => {
        const val = (e.attendance && (e.attendance[m] ?? "")) || "";
        if(val !== "Anwesend") return;

        if(e.type === "Ãœbung") u++;
        else if(e.type === "Einsatz") ei++;
        else if(e.type === "Prozession") pr++;
        else if(e.type === "Bereitschaftsdienst") bd++;
        else if(e.type === "Veranstaltung") va++;
        else if(e.type === "Sonstiges") so++;
      });

      return { m, u, ei, pr, bd, va, so, total: u+ei+pr+bd+va+so };
    });

    const table = document.createElement("table");
    table.style.border = "1px solid var(--line)";
    table.style.borderRadius = "12px";
    table.style.overflow = "hidden";
    table.innerHTML = `
      <thead>
        <tr>
          <th style="min-width:220px;">Mitglied</th>
          <th>Ãœbung</th>
          <th>Einsatz</th>
          <th>Prozession</th>
          <th>Bereitschaft</th>
          <th>Veranst.</th>
          <th>Sonst.</th>
          <th>Summe</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td><b>${escapeHtml(r.m)}</b></td>
            <td>${r.u}</td>
            <td>${r.ei}</td>
            <td>${r.pr}</td>
            <td>${r.bd}</td>
            <td>${r.va}</td>
            <td>${r.so}</td>
            <td><b>${r.total}</b></td>
          </tr>
        `).join("")}
      </tbody>
    `;
    box.appendChild(table);
  }

  function renderAlarmStats(){
    const box = document.getElementById("alarmStatsBox");
    box.innerHTML = "";

    const base = data.entries.filter(e => {
      if(activeFilter.year && yearOf(e.date) !== activeFilter.year) return false;
      if(activeFilter.type !== "ALLE" && e.type !== activeFilter.type) return false;
      return true;
    });

    const counts = { A1:0,A2:0,A3:0,A4:0,A5:0,A6:0,A7:0,A8:0, "â€”":0 };
    base.forEach(e => {
      if(e.type !== "Einsatz") return;
      const a = (e.alarm || "").trim();
      if(counts[a] !== undefined) counts[a] += 1;
      else counts["â€”"] += 1;
    });

    const order = ["A1","A2","A3","A4","A5","A6","A7","A8","â€”"];
    const table = document.createElement("table");
    table.style.border = "1px solid var(--line)";
    table.style.borderRadius = "12px";
    table.style.overflow = "hidden";
    table.innerHTML = `
      <thead><tr><th>Alarmstufe</th><th>Anzahl EinsÃ¤tze</th></tr></thead>
      <tbody>
        ${order.map(k => `
          <tr>
            <td>${k === "â€”" ? "<span class='muted'>ohne</span>" : k}</td>
            <td><b>${counts[k]}</b></td>
          </tr>
        `).join("")}
      </tbody>
    `;
    box.appendChild(table);
  }

 function renderEntries(entries){
  const body = document.getElementById("entriesBody");
  body.innerHTML = "";

  if(entries.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" class="muted" style="padding:14px;">Keine EintrÃ¤ge (oder Filter zu streng).</td>`;
    body.appendChild(tr);
    return;
  }

  entries.forEach(e => {
    const tr = document.createElement("tr");

    const titleNote = [
      e.title ? `<b>${escapeHtml(e.title)}</b>` : `<span class="muted">â€”</span>`,
      e.note ? `<div class="muted" style="margin-top:2px;white-space:pre-wrap;">${escapeHtml(e.note)}</div>` : ``,
      (e.type === "Einsatz" && e.alarm) ? `<div style="margin-top:4px;"><span class="tag">Alarm: ${escapeHtml(e.alarm)}</span></div>` : ``
    ].join("");

    // Auswertung bleibt kompakt: nur Pills
    const sums = entrySums(e, activeFilter.member);
    const summaryHtml = `
  <span class="pill">Anwesend: ${sums.anwesend}</span>
`;

    // Details-Inhalt (wie bisher), aber jetzt im Action-Bereich
    const detailsHtml = entryDetails(e, activeFilter.member);
    const detId = `det_${escapeAttr(e.id)}`;

    tr.innerHTML = `
      <td>${escapeHtml(e.date)}</td>
      <td>${escapeHtml(e.type)}</td>
      <td>${titleNote}</td>
      <td>${summaryHtml}</td>
      <td class="actions-cell">
        <div class="entry-actions">
          <button class="small" data-edit="${escapeAttr(e.id)}">Bearbeiten</button>
          <button class="small ghost" data-toggle-details="${escapeAttr(e.id)}">Details anzeigen</button>
          <button class="small danger" data-del="${escapeAttr(e.id)}">LÃ¶schen</button>

          <div class="entry-details" id="${detId}" style="display:none;">
            ${detailsHtml}
          </div>
        </div>
      </td>
    `;
    body.appendChild(tr);
  });

  // Bearbeiten
  body.querySelectorAll("button[data-edit]").forEach(btn => {
    btn.addEventListener("click", () => startEdit(btn.getAttribute("data-edit")));
  });

  // Details anzeigen (toggle)
  body.querySelectorAll("button[data-toggle-details]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-toggle-details");
      const box = document.getElementById(`det_${id}`);
      if(!box) return;

      const isOpen = box.style.display !== "none";
      box.style.display = isOpen ? "none" : "block";
      btn.textContent = isOpen ? "Details anzeigen" : "Details ausblenden";
    });
  });

  // LÃ¶schen
  body.querySelectorAll("button[data-del]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-del");
      if(!confirm("Eintrag wirklich lÃ¶schen?")) return;

      data.entries = data.entries.filter(x => x.id !== id);
      save();
      rebuildYearOptions();
      renderAll();
    });
  });
}


  function applyFilters(entries){
    return entries.filter(e => {
      if(activeFilter.year && yearOf(e.date) !== activeFilter.year) return false;
      if(activeFilter.type !== "ALLE" && e.type !== activeFilter.type) return false;
      if(activeFilter.member !== "ALLE"){
        const v = (e.attendance && (e.attendance[activeFilter.member] ?? "")) || "";
        if(v === "") return false;
      }
      return true;
    });
  }

  function entrySums(entry, memberFilter){
    let anwesend = 0, hinterlegt = 0;

    if(memberFilter !== "ALLE"){
      const v = (entry.attendance && (entry.attendance[memberFilter] ?? "")) || "";
      hinterlegt = (v !== "") ? 1 : 0;
      anwesend = (v === "Anwesend") ? 1 : 0;
      return { anwesend, hinterlegt };
    }

    MEMBERS.forEach(m => {
      const v = (entry.attendance && (entry.attendance[m] ?? "")) || "";
      if(v !== "") hinterlegt++;
      if(v === "Anwesend") anwesend++;
    });
    return { anwesend, hinterlegt };
  }

  function entryDetails(entry, memberFilter){
    if(memberFilter !== "ALLE"){
      const v = (entry.attendance && (entry.attendance[memberFilter] ?? "")) || "";
      const statusText = v === "" ? "â€“ (nicht hinterlegt)" : escapeHtml(v);
      return `<div style="margin-top:8px;">
        <span class="pill">${escapeHtml(memberFilter)}: ${statusText}</span>
      </div>`;
    }

    const pills = MEMBERS.map(m => {
      const v = (entry.attendance && (entry.attendance[m] ?? "")) || "";
      if(v === "") return null;
      return `<span class="pill">${escapeHtml(m)}: ${escapeHtml(v)}</span>`;
    }).filter(Boolean).join("");

    return pills ? `<div style="margin-top:8px;">${pills}</div>`
                 : `<div class="muted" style="margin-top:8px;">Keine Mitglieder hinterlegt.</div>`;
  }

  function rebuildYearOptions(){
    const years = yearsFromEntries(data.entries);
    const currentYear = String(new Date().getFullYear());
    if(!years.includes(currentYear)) years.push(currentYear);
    years.sort((a,b)=> b.localeCompare(a));

    const prev = filterYear.value;
    filterYear.innerHTML = "";
    years.forEach(y => {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      filterYear.appendChild(opt);
    });

    if(prev && years.includes(prev)) filterYear.value = prev;
    else filterYear.value = years[0] || currentYear;
  }

  function defaultYear(){
    const years = yearsFromEntries(data.entries).sort((a,b)=> b.localeCompare(a));
    const currentYear = String(new Date().getFullYear());
    if(years.includes(currentYear)) return currentYear;
    return years[0] || currentYear;
  }

  function yearsFromEntries(entries){
    const set = new Set();
    entries.forEach(e => { const y = yearOf(e.date); if(y) set.add(y); });
    return Array.from(set);
  }
  function yearOf(dateStr){ return (!dateStr || dateStr.length < 4) ? "" : dateStr.slice(0,4); }

  function countByType(entries){
    const out = {
      "Ãœbung":0,
      "Einsatz":0,
      "Prozession":0,
      "Bereitschaftsdienst":0,
      "Veranstaltung":0,
      "Sonstiges":0
    };
    entries.forEach(e => { if(out[e.type] !== undefined) out[e.type]++; });
    return out;
  }

  // CSV: id,date,type,alarm,title,note,<member...>
  function exportCSV(){
    const header = ["id","date","type","alarm","title","note", ...MEMBERS];
    const lines = [header.map(csvEscape).join(",")];

    data.entries.forEach(e => {
      const row = [
        e.id, e.date, e.type, e.alarm || "", e.title || "",
        (e.note || "").replace(/\r?\n/g, "\\n"),
        ...MEMBERS.map(m => (e.attendance && (e.attendance[m] ?? "")) || "")
      ];
      lines.push(row.map(csvEscape).join(","));
    });

    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "anwesenheit_feuerwehr.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function importCSV(ev){
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;

    const text = await file.text();
    const rows = parseCSV(text);
    if(rows.length < 2){
      alert("CSV scheint leer/ungÃ¼ltig.");
      ev.target.value = "";
      return;
    }

    const header = rows[0];
    const baseRequired = ["id","date","type","alarm","title","note"];
    const missingBase = baseRequired.filter(h => !header.includes(h));
    if(missingBase.length){
      alert("CSV Header passt nicht. Fehlend: " + missingBase.join(", "));
      ev.target.value = "";
      return;
    }

    const membersFromCSV = header.filter(h => !baseRequired.includes(h)).map(normalizeMemberName).filter(Boolean);
    const memberCols = membersFromCSV.length ? membersFromCSV : [...MEMBERS];

    const union = Array.from(new Set([...MEMBERS, ...memberCols]));
    if(union.length !== MEMBERS.length){
      MEMBERS = saveMembers(union);
      buildMembersUI();
      renderMemberAdminList();
    }

    const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
    const imported = [];

    for(let r=1; r<rows.length; r++){
      const row = rows[r];
      if(row.length === 0) continue;

      const attendance = {};
      memberCols.forEach(m => attendance[m] = row[idx[m]] ?? "");

      imported.push({
        id: row[idx.id] || cryptoId(),
        date: row[idx.date],
        type: row[idx.type] || "Ãœbung",
        alarm: row[idx.alarm] || "",
        title: row[idx.title] || "",
        note: (row[idx.note] || "").replace(/\\n/g, "\n"),
        attendance
      });
    }

    const map = new Map(data.entries.map(e => [e.id, e]));
    imported.forEach(e => map.set(e.id, e));
    data.entries = Array.from(map.values()).sort((a,b)=>b.date.localeCompare(a.date));
    save();

    rebuildYearOptions();
    renderAll();

    ev.target.value = "";
    alert("Import erfolgreich: " + imported.length + " EintrÃ¤ge Ã¼bernommen/aktualisiert.");
  }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        const parsed = JSON.parse(raw);
        if(!parsed.entries) parsed.entries = [];
        parsed.entries.forEach(e => { if(!e.attendance) e.attendance = {}; });
        return parsed;
      }
      return { entries: [] };
    } catch {
      return { entries: [] };
    }
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }

  function cryptoId(){
    if(window.crypto && crypto.getRandomValues){
      const a = new Uint32Array(4);
      crypto.getRandomValues(a);
      return Array.from(a).map(x => x.toString(16)).join("");
    }
    return String(Date.now()) + Math.random().toString(16).slice(2);
  }

  function hashId(s){
    return String(s).toLowerCase()
      .replaceAll("Ã¤","ae").replaceAll("Ã¶","oe").replaceAll("Ã¼","ue").replaceAll("ÃŸ","ss")
      .replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "");
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s).replaceAll("`","&#096;"); }
  function cssEscape(s){ return String(s ?? "").replaceAll('"','\\"'); }

  function csvEscape(v){
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }

  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for(let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];
      if(inQuotes){
        if(ch === '"' && next === '"'){ cur += '"'; i++; }
        else if(ch === '"'){ inQuotes = false; }
        else cur += ch;
      } else {
        if(ch === '"'){ inQuotes = true; }
        else if(ch === ","){ row.push(cur); cur = ""; }
        else if(ch === "\n"){ row.push(cur); rows.push(row); row = []; cur = ""; }
        else if(ch === "\r"){ /* ignore */ }
        else cur += ch;
      }
    }
    if(cur.length || row.length){ row.push(cur); rows.push(row); }
    return rows.filter(r => r.some(c => String(c).trim() !== ""));
  }
</script>
</body>
</html>
